<!DOCTYPE html>
<html>

<head>
  <title>Raw WebRTC</title>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <video id='local' autoplay width=400></video>
  <video id='remote' autoplay width=400></video>

  <script>
    const socket = io('http://localhost:8000', {
      transports: ['websockets', 'polling']
    });
    const local = new RTCPeerConnection()
    const remote = new RTCPeerConnection()

    local.onicecandidate = e => {
      if (e.candidate) {
        console.log('local ice', e.candidate)
        remote.addIceCandidate(e.candidate)
      }
    }
    remote.onicecandidate = e => {
      if (e.candidate) {
        console.log('remote ice', e.candidate)
        local.addIceCandidate(e.candidate)
      }
    }
    remote.onaddstream = e => {
      document.getElementById('remote').srcObject = e.stream
    }

    socket.on('connect', () => {
      socket.emit('join', socket.id)
    })
    socket.on('welcome', msg => {
      console.log(msg)
    })
    socket.on('broadcast', () => {
      socket.emit('watcher', socket.id)
    })
    socket.on('watcher', id => {
      console.log('we watching!', window.stream)
      local.addStream(window.stream)
      socket.emit('offer', socket.id)
    })

    socket.on('offer', () => {
      local.createOffer()
        .then(offer => local.setLocalDescription(offer))
        .then(() => remote.setRemoteDescription(local.localDescription))
        .then(() => {
          socket.emit('answer', local.localDescription)
        })
    })
    socket.on('answer', desc => {
      remote.createAnswer()
        .then(answer => remote.setLocalDescription(answer))
        .then(() => local.setRemoteDescription(remote.localDescription))
    })

    // After a RTC connection is created the first client has
    // to send his RTC offer to the second client, and set
    // the RTC local description with his created offer.
    navigator.mediaDevices.getUserMedia({
        video: true
      })
      .then(stream => {
        // document.getElementById('local').srcObject = stream
        window.stream = stream
        socket.emit('broadcast')
      })
  </script>
</body>

</html>